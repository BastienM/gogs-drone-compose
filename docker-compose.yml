version: '2'
services:
  proxy:
    image: traefik
    command: --web --docker --logLevel=DEBUG
    networks:
      - web-tier
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /dev/null:/traefik.toml

  gogs:
    image: gogs/gogs:0.11.19
    container_name: gogs
    networks:
      - db-tier
      - web-tier
      - ci-tier
    ports:
      - "3022:22"
    volumes:
      - /data"
    labels:
      - "traefik.backend=gogs"
      - "traefik.protocol=http"
      - "traefik.frontend.rule=Host:gogs.internal.cloud"
      - "traefik.port=3000"
      - "traefik.docker.network=web-tier"

  gogs-db:
    image: postgres:9.1
    container_name: gogs-database
    networks:
      - db-tier
    environment:
      - POSTGRES_USER=gogs
      - POSTGRES_PASSWORD=gogs
    volumes:
      - /var/lib/postgresql/data
    labels:
      - "traefik.enable=false"

  drone-server:
    image: drone/drone:0.7
    container_name: drone
    networks:
      - web-tier
      - ci-tier
    environment:
      - DRONE_SECRET=gogsdronecompose
      - DRONE_OPEN=true
      - DRONE_HOST=http://drone.internal.cloud
      - DRONE_GOGS=true
      - DRONE_GOGS_URL=http://gogs
      - DEBUG=true
    volumes:
      - /var/lib/drone
    labels:
      - "traefik.backend=drone"
      - "traefik.protocol=http"
      - "traefik.port=8000"
      - "traefik.frontend.rule=Host:drone.internal.cloud"
      - "traefik.docker.network=web-tier"
    
  drone-agent:
    image: drone/drone:0.7
    command: agent
    networks:
      - ci-tier
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DRONE_SERVER=ws://drone-server:8000/ws/broker
      - DRONE_SECRET=gogsdronecompose
    labels:
      - "traefik.enable=false"

networks:
  db-tier:
    driver: bridge
  ci-tier:
    driver: bridge
  web-tier:
    driver: bridge
